#define RX_BUFFER_BASE      (XPAR_DDR_MEM_BASEADDR + 0x01000000)   // DDR + 16MB
#define NUM_SAMPLES         4096
#define BYTES_PER_SAMPLE    4
#define DMA_TRANSFER_SIZE   (NUM_SAMPLES * BYTES_PER_SAMPLE)


#include "xaxidma.h"
#include "xparameters.h"
#include "xil_printf.h"

XAxiDma AxiDma;

int init_dma()
{
    int Status;
    XAxiDma_Config *CfgPtr;

    xil_printf("Initializing DMA...\r\n");

    CfgPtr = XAxiDma_LookupConfig(XPAR_AXIDMA_0_DEVICE_ID);
    if (!CfgPtr) {
        xil_printf("No DMA config found!\r\n");
        return XST_FAILURE;
    }

    Status = XAxiDma_CfgInitialize(&AxiDma, CfgPtr);
    if (Status != XST_SUCCESS) {
        xil_printf("DMA init failed!\r\n");
        return XST_FAILURE;
    }

    if (XAxiDma_HasSg(&AxiDma)) {
        xil_printf("Error: SG mode enabled! Should be Simple Mode!\r\n");
        return XST_FAILURE;
    }

    xil_printf("DMA init OK.\r\n");
    return XST_SUCCESS;
}

int start_dma_receive()
{
    int Status;

    // DMA가 데이터를 DDR에 쓰기 전에 캐시 flush
    Xil_DCacheFlushRange(RX_BUFFER_BASE, DMA_TRANSFER_SIZE);

    xil_printf("Starting DMA receive of %d bytes...\r\n", DMA_TRANSFER_SIZE);

    Status = XAxiDma_SimpleTransfer(
                &AxiDma,
                (UINTPTR)RX_BUFFER_BASE,
                DMA_TRANSFER_SIZE,
                XAXIDMA_DEVICE_TO_DMA);

    if (Status != XST_SUCCESS) {
        xil_printf("DMA transfer setup failed!\r\n");
        return XST_FAILURE;
    }

    return XST_SUCCESS;
}


int main()
{
    init_dma();
    while(1);
    return 0;
}
