#include "xaxidma.h"
#include "xparameters.h"
#include "xil_printf.h"
#include "xil_cache.h"
#include "xstatus.h"

#define DMA_DEV_ID          XPAR_AXIDMA_0_DEVICE_ID

// 안전한 DDR 영역 하나를 직접 지정 (4KB/4byte 정렬)
#define RX_BUFFER_BASE      0x01000000U
#define NUM_SAMPLES         4095PMU-FW is not running, certain applications may not be supported.
Initializing DMA...
DMA init OK.
DMA Base Address = 0xA0000000
Resetting S2MM channel...
S2MM reset done.
RX_BUFFER_BASE = 0x01000000, LEN = 16384
Starting DMA receive of 16384 bytes...
SimpleTransfer return = 15
S2MM status reg = 0x00000001
DMA transfer setup failed! (XST_INVALID_PARAM=15)
U
#define BYTES_PER_SAMPLE    4U
#define DMA_TRANSFER_SIZE   (NUM_SAMPLES * BYTES_PER_SAMPLE)   // 16384 bytes

static XAxiDma AxiDma;

int init_dma(void)
{
    int Status;
    XAxiDma_Config *CfgPtr;

    xil_printf("Initializing DMA...\r\n");

    CfgPtr = XAxiDma_LookupConfig(DMA_DEV_ID);
    if (CfgPtr == NULL) {
        xil_printf("No DMA config found!\r\n");
        return XST_FAILURE;
    }

    Status = XAxiDma_CfgInitialize(&AxiDma, CfgPtr);
    if (Status != XST_SUCCESS) {
        xil_printf("DMA init failed! status = %d\r\n", Status);
        return XST_FAILURE;
    }

    if (XAxiDma_HasSg(&AxiDma)) {
        xil_printf("Error: DMA is in SG mode! Need Simple mode.\r\n");
        return XST_FAILURE;
    }

    xil_printf("DMA init OK.\r\n");
    xil_printf("DMA Base Address = 0x%08lx\r\n", AxiDma.RegBase);

    return XST_SUCCESS;
}

void reset_s2mm(void)
{
    xil_printf("Resetting S2MM channel...\r\n");

    XAxiDma_Reset(&AxiDma);
    while (!XAxiDma_ResetIsDone(&AxiDma)) {
        // busy wait
    }

    xil_printf("S2MM reset done.\r\n");
}

int start_dma_receive(void)
{
    u32 Status;
    u32 S2mmSr;

    xil_printf("RX_BUFFER_BASE = 0x%08lx, LEN = %lu\r\n",
               (u32)RX_BUFFER_BASE, (u32)DMA_TRANSFER_SIZE);

    // S2MM: 전송 전에는 flush 안 해도 되지만, 안전하게 유지
    Xil_DCacheFlushRange(RX_BUFFER_BASE, DMA_TRANSFER_SIZE);

    xil_printf("Starting DMA receive of %d bytes...\r\n", DMA_TRANSFER_SIZE);

    // 실제 DMA 시작
    Status = XAxiDma_SimpleTransfer(
                 &AxiDma,
                 (UINTPTR)RX_BUFFER_BASE,
                 DMA_TRANSFER_SIZE,
                 XAXIDMA_DEVICE_TO_DMA    // Stream→Memory
             );

    xil_printf("SimpleTransfer return = %lu\r\n", Status);

    S2mmSr = XAxiDma_ReadReg(
                 AxiDma.RegBase + XAXIDMA_RX_OFFSET,
                 XAXIDMA_SR_OFFSET
             );
    xil_printf("S2MM status reg = 0x%08lx\r\n", S2mmSr);

    if (Status != XST_SUCCESS) {
        xil_printf("DMA transfer setup failed! (XST_INVALID_PARAM=%d)\r\n",
                   XST_INVALID_PARAM);
        return XST_FAILURE;
    }

    return XST_SUCCESS;
}

int main(void)
{
    if (init_dma() != XST_SUCCESS) {
        xil_printf("init_dma failed\r\n");
        return XST_FAILURE;
    }

    reset_s2mm();

    start_dma_receive();

    while (1) {
        // 나중에 여기서 DMA 완료 체크/데이터 확인 추가
    }

    return 0;
}
